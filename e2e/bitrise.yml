format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

workflows:
  test_start_ios:
    envs:
    - DESTINATION: platform=iOS Simulator,name=Bitrise iOS default,OS=latest
    - TIMEOUT: 90
    after_run:
    - _run
    - _check_outputs
  
  test_start_visionos:
    envs:
    - DESTINATION: platform=visionOS Simulator,name=Apple Vision Pro,OS=1.0
    - TIMEOUT: 90
    after_run:
    - _run
    - _check_outputs

  test_start_rosetta:
    description: Rosetta Simulator requires Xcode 14.3+.
    steps:
    - bitrise-run:
        run_if: |-
          {{ or (enveq "IS_LATEST_STACK_XCODE" "true") (not .IsCI) }}
        inputs:
        - workflow_id: utility_test_start_rosetta
        - bitrise_config_path: ./e2e/bitrise.yml

  utility_test_start_rosetta:
    envs:
    - DESTINATION: platform=iOS Simulator,name=Bitrise iOS default,OS=latest,arch=x86_64
    - TIMEOUT: 300
    after_run:
    - _run
    - _check_outputs

  test_create_device:
    envs:
    - DESTINATION: platform=iOS Simulator,name=iPhone 11 Pro Max,OS=latest
    - TIMEOUT: 0
    after_run:
    - _run
    - _check_outputs

  _run:
    steps:
    - path::./:
        inputs:
        - destination: $DESTINATION
        - reset: "yes"
        - wait_for_boot_timeout: $TIMEOUT

  _check_outputs:
    steps:
    - git::https://github.com/bitrise-steplib/bitrise-step-check-step-outputs.git@main:
        is_always_run: true
        inputs:
        - envs: |-
            BITRISE_SIMULATOR_STATUS
            BITRISE_XCODE_DESTINATION
        - files:
        - dirs:
        - deploy_dir:
        - deployed_files:
        - deployed_dirs:
